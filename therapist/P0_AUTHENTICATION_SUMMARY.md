# âœ… P0 è®¤è¯å¢å¼ºåŠŸèƒ½å®ç°æ€»ç»“

## ğŸ“‹ å®ç°å†…å®¹

### åŠŸèƒ½ 1: Token è‡ªåŠ¨åˆ·æ–°æœºåˆ¶

**é—®é¢˜**: å½“å‰ 401 ç›´æ¥é€€å‡ºç™»å½•ï¼Œç”¨æˆ·ä½“éªŒå·®  
**è§£å†³**: åœ¨ token è¿‡æœŸæ—¶è‡ªåŠ¨åˆ·æ–°ï¼Œç”¨æˆ·æ— æ„ŸçŸ¥

#### å®ç°æ–‡ä»¶

1. **åç«¯**:
   - `backend/app/api/v1/therapist_auth.py`
     - âœ… æ·»åŠ  `GET /therapist/auth/profile` æ¥å£ï¼ˆéªŒè¯ token å¹¶è·å–ç”¨æˆ·ä¿¡æ¯ï¼‰
     - âœ… å·²æœ‰ `POST /therapist/auth/refresh` æ¥å£

2. **å‰ç«¯**:
   - `therapist/src/store/authSlice.ts`
     - âœ… æ·»åŠ  `updateToken` actionï¼ˆæ›´æ–° tokenï¼‰
   
   - `therapist/src/api/client.ts`
     - âœ… æ·»åŠ  token åˆ·æ–°çŠ¶æ€ç®¡ç†ï¼ˆ`isRefreshing`, `failedQueue`ï¼‰
     - âœ… ä¿®æ”¹å“åº”æ‹¦æˆªå™¨ï¼š
       - é‡åˆ° 401 â†’ å°è¯•åˆ·æ–° token
       - åˆ·æ–°æˆåŠŸ â†’ é‡è¯•åŸå§‹è¯·æ±‚
       - åˆ·æ–°å¤±è´¥ â†’ é€€å‡ºç™»å½•
       - æ”¯æŒå¹¶å‘è¯·æ±‚é˜Ÿåˆ—ç®¡ç†
   
   - `therapist/src/api/auth.ts`
     - âœ… ä¿®æ”¹ `refreshToken` å‡½æ•°ç­¾åï¼ˆæ¥æ”¶ refreshTokenValue å‚æ•°ï¼‰
     - âœ… ä¿®æ”¹ `getCurrentTherapist` è·¯å¾„ï¼ˆ`/therapist/auth/profile`ï¼‰

---

### åŠŸèƒ½ 2: æŒä¹…åŒ–çŠ¶æ€æ¢å¤

**é—®é¢˜**: App é‡å¯åæœªéªŒè¯ token æœ‰æ•ˆæ€§ï¼Œå¯èƒ½å¯¼è‡´è¿›å…¥ä¸»é¡µåç«‹å³ 401  
**è§£å†³**: å¯åŠ¨æ—¶éªŒè¯ tokenï¼Œè‡ªåŠ¨åˆ·æ–°æˆ–é€€å‡ºç™»å½•

#### å®ç°æ–‡ä»¶

1. **å‰ç«¯**:
   - `therapist/src/hooks/useAuthCheck.ts` **(æ–°å»º)**
     - âœ… åˆ›å»ºå¯åŠ¨éªŒè¯ Hook
     - âœ… æ£€æŸ¥ token æœ‰æ•ˆæ€§
     - âœ… Token è¿‡æœŸæ—¶å°è¯•åˆ·æ–°
     - âœ… åˆ·æ–°å¤±è´¥æ—¶é€€å‡ºç™»å½•
   
   - `therapist/App.tsx`
     - âœ… åˆ›å»º `AppContent` ç»„ä»¶
     - âœ… é›†æˆ `useAuthCheck` Hook
     - âœ… æ˜¾ç¤º "æ­£åœ¨éªŒè¯ç™»å½•çŠ¶æ€..." åŠ è½½ç•Œé¢

---

## ğŸ”„ æµç¨‹å›¾

### Token è‡ªåŠ¨åˆ·æ–°æµç¨‹

```
ç”¨æˆ·å‘èµ·è¯·æ±‚
  â†“
æºå¸¦ access_token
  â†“
åç«¯è¿”å› 401
  â†“
æ‹¦æˆªå™¨æ•è· 401
  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ˜¯å¦æ­£åœ¨åˆ·æ–°ï¼Ÿ      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ˜¯ â†’ åŠ å…¥é˜Ÿåˆ—ç­‰å¾…   â”‚
â”‚ å¦ â†’ å¼€å§‹åˆ·æ–°       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â†“
ä½¿ç”¨ refresh_token è¯·æ±‚ /refresh
  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åˆ·æ–°ç»“æœ            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æˆåŠŸ â†’ æ›´æ–° Redux   â”‚
â”‚      â†’ å¤„ç†é˜Ÿåˆ—     â”‚
â”‚      â†’ é‡è¯•è¯·æ±‚ âœ…  â”‚
â”‚                     â”‚
â”‚ å¤±è´¥ â†’ æ¸…ç©ºé˜Ÿåˆ—     â”‚
â”‚      â†’ é€€å‡ºç™»å½• âŒ  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### App å¯åŠ¨çŠ¶æ€éªŒè¯æµç¨‹

```
App å¯åŠ¨
  â†“
PersistGate æ¢å¤ Redux state
  â†“
AppContent ç»„ä»¶æŒ‚è½½
  â†“
useAuthCheck Hook æ‰§è¡Œ
  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ£€æŸ¥ç™»å½•çŠ¶æ€        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æœªç™»å½• â†’ è·³è¿‡éªŒè¯   â”‚
â”‚ å·²ç™»å½• â†’ ç»§ç»­éªŒè¯   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â†“
è°ƒç”¨ /therapist/auth/profile
  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Token éªŒè¯ç»“æœ      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æœ‰æ•ˆ â†’ æ›´æ–°ç”¨æˆ·ä¿¡æ¯ â”‚
â”‚      â†’ è¿›å…¥ä¸»é¡µ âœ…  â”‚
â”‚                     â”‚
â”‚ æ— æ•ˆ â†’ å°è¯•åˆ·æ–°     â”‚
â”‚   â†“                 â”‚
â”‚   â”œâ”€ æˆåŠŸ â†’ ä¸»é¡µ âœ… â”‚
â”‚   â””â”€ å¤±è´¥ â†’ é€€å‡º âŒ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ å…³é”®ç‰¹æ€§

### 1. é˜²æ­¢å¹¶å‘åˆ·æ–°

```typescript
let isRefreshing = false;
let failedQueue = [];

if (isRefreshing) {
  // åŠ å…¥é˜Ÿåˆ—ç­‰å¾…
  return new Promise((resolve, reject) => {
    failedQueue.push({ resolve, reject });
  });
}
```

### 2. è¯·æ±‚é‡è¯•æœºåˆ¶

```typescript
if (status === 401 && !originalRequest._retry) {
  originalRequest._retry = true; // é˜²æ­¢æ— é™å¾ªç¯
  
  // åˆ·æ–° token
  const newToken = await refreshToken();
  
  // é‡è¯•åŸå§‹è¯·æ±‚
  originalRequest.headers.Authorization = `Bearer ${newToken}`;
  return apiClient(originalRequest);
}
```

### 3. å¯åŠ¨æ—¶å»¶è¿Ÿå¯¼èˆª

```typescript
function AppContent() {
  const { isChecking } = useAuthCheck();
  
  if (isChecking) {
    return <LoadingScreen />;
  }
  
  return <RootNavigator />;
}
```

---

## ğŸ“¦ æ–‡ä»¶æ¸…å•

### åç«¯ä¿®æ”¹

- âœ… `backend/app/api/v1/therapist_auth.py`
  - æ·»åŠ  `GET /profile` æ¥å£

### å‰ç«¯ä¿®æ”¹

- âœ… `therapist/src/store/authSlice.ts`
  - æ·»åŠ  `updateToken` action

- âœ… `therapist/src/api/client.ts`
  - é‡å†™å“åº”æ‹¦æˆªå™¨ï¼ˆtoken è‡ªåŠ¨åˆ·æ–°ï¼‰

- âœ… `therapist/src/api/auth.ts`
  - ä¿®æ”¹ `refreshToken` å’Œ `getCurrentTherapist`

### å‰ç«¯æ–°å¢

- âœ… `therapist/src/hooks/useAuthCheck.ts` **(æ–°å»º)**
  - å¯åŠ¨éªŒè¯ Hook

### å‰ç«¯é›†æˆ

- âœ… `therapist/App.tsx`
  - é›†æˆ `useAuthCheck`

---

## ğŸ§ª æµ‹è¯•

è¯¦ç»†æµ‹è¯•æŒ‡å—è¯·å‚é˜…: **`AUTHENTICATION_TESTING_GUIDE.md`**

---

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### å¼€å‘æ¨¡å¼

1. å¯åŠ¨åç«¯:
   ```powershell
   cd backend
   docker-compose up -d
   ```

2. å¯åŠ¨å‰ç«¯:
   ```powershell
   cd therapist
   npx expo start -c
   ```

3. ç™»å½•æµ‹è¯•è´¦å·:
   - æ‰‹æœºå·: `13800138000`
   - éªŒè¯ç : `888888`

### éªŒè¯åŠŸèƒ½

1. **æµ‹è¯• Token è‡ªåŠ¨åˆ·æ–°**:
   - ä¸´æ—¶ä¿®æ”¹ `ACCESS_TOKEN_EXPIRE_MINUTES = 1`
   - ç™»å½•åç­‰å¾… 1 åˆ†é’Ÿ
   - è§¦å‘ä»»æ„éœ€è¦è®¤è¯çš„æ“ä½œ
   - âœ… åº”è¯¥è‡ªåŠ¨åˆ·æ–°ï¼Œä¸é€€å‡ºç™»å½•

2. **æµ‹è¯•å¯åŠ¨çŠ¶æ€æ¢å¤**:
   - ç™»å½•åå…³é—­ App
   - é‡æ–°æ‰“å¼€ App
   - âœ… åº”è¯¥æ˜¾ç¤º "æ­£åœ¨éªŒè¯ç™»å½•çŠ¶æ€..."
   - âœ… è‡ªåŠ¨è¿›å…¥ä¸»é¡µï¼Œæ— éœ€é‡æ–°ç™»å½•

---

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **ç”Ÿäº§ç¯å¢ƒé…ç½®**:
   - `ACCESS_TOKEN_EXPIRE_MINUTES`: 7 å¤©ï¼ˆé»˜è®¤ï¼‰
   - `REFRESH_TOKEN_EXPIRE_DAYS`: 30 å¤©ï¼ˆé»˜è®¤ï¼‰

2. **é”™è¯¯å¤„ç†**:
   - ç½‘ç»œé”™è¯¯ä¸ä¼šè§¦å‘åˆ·æ–°
   - åªæœ‰ 401 çŠ¶æ€ç ä¼šè§¦å‘åˆ·æ–°
   - åˆ·æ–°å¤±è´¥ä¼šè‡ªåŠ¨é€€å‡ºç™»å½•

3. **æ—¥å¿—è¾“å‡º**:
   - å¼€å‘æ¨¡å¼ä¸‹æœ‰è¯¦ç»†çš„æ—¥å¿—è¾“å‡º
   - ç”Ÿäº§ç¯å¢ƒå»ºè®®å…³é—­æˆ–ä½¿ç”¨æ—¥å¿—æœåŠ¡

---

## âœ… å®ŒæˆçŠ¶æ€

- [x] åç«¯ï¼šæ·»åŠ  `/therapist/auth/profile` æ¥å£
- [x] å‰ç«¯ï¼šauthSlice æ·»åŠ  `updateToken` action
- [x] å‰ç«¯ï¼šclient.ts å®ç° Token è‡ªåŠ¨åˆ·æ–°æ‹¦æˆªå™¨
- [x] å‰ç«¯ï¼šåˆ›å»º `useAuthCheck` Hook
- [x] å‰ç«¯ï¼šApp.tsx é›†æˆå¯åŠ¨æ£€æŸ¥
- [ ] æµ‹è¯•ï¼šéªŒè¯ Token è‡ªåŠ¨åˆ·æ–°æµç¨‹
- [ ] æµ‹è¯•ï¼šéªŒè¯ App å¯åŠ¨çŠ¶æ€æ¢å¤

---

## ğŸ‰ ä¸‹ä¸€æ­¥

å»ºè®®æŒ‰ç…§ `AUTHENTICATION_TESTING_GUIDE.md` è¿›è¡Œå®Œæ•´æµ‹è¯•ï¼Œç¡®ä¿æ‰€æœ‰åŠŸèƒ½æ­£å¸¸å·¥ä½œã€‚

æµ‹è¯•é€šè¿‡åï¼Œå¯ä»¥ç»§ç»­å®ç° **P1 æ ¸å¿ƒæ•°æ®æ¥å£**ï¼š
- æŠ€å¸ˆä¸ªäººä¿¡æ¯ç®¡ç†
- è®¢å•ç®¡ç†
- æ”¶å…¥ç»Ÿè®¡

