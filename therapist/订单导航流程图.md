# æŠ€å¸ˆç«¯è®¢å•å¯¼èˆªæµç¨‹å›¾

## ç”¨æˆ·æ“ä½œæµç¨‹

```mermaid
graph TD
    A[ğŸ“± æ‰“å¼€ App] --> B[ğŸ“‹ è®¢å•åˆ—è¡¨é¡µé¢]
    B --> C{é€‰æ‹© Tab}
    C -->|å¾…æ¥å•| D[æ˜¾ç¤º PENDING è®¢å•]
    C -->|è¿›è¡Œä¸­| E[æ˜¾ç¤ºè¿›è¡Œä¸­è®¢å•]
    C -->|å·²å®Œæˆ| F[æ˜¾ç¤ºå·²å®Œæˆè®¢å•]
    
    D --> G[ğŸ–±ï¸ ç‚¹å‡»è®¢å•å¡ç‰‡]
    E --> G
    
    G --> H[ğŸ“„ è®¢å•è¯¦æƒ…é¡µé¢]
    
    H --> I{è®¢å•çŠ¶æ€?}
    
    I -->|PENDING| J[æ˜¾ç¤º: æ‹’ç» / æ¥å—è®¢å•]
    I -->|CONFIRMED<br/>EN_ROUTE<br/>IN_PROGRESS| K[æ˜¾ç¤º: å¼€å§‹å¯¼èˆªæŒ‰é’®]
    
    J -->|ç‚¹å‡»æ¥å—| L[è°ƒç”¨ API æ¥å•]
    L --> M[çŠ¶æ€å˜ä¸º CONFIRMED]
    M --> K
    
    K --> N[ğŸ–±ï¸ ç‚¹å‡» å¼€å§‹å¯¼èˆª]
    N --> O[ğŸ—ºï¸ å¯¼èˆªé¡µé¢]
    
    O --> P[æ˜¾ç¤ºåœ°å›¾ + åº•éƒ¨ä¿¡æ¯]
    P --> Q{ç”¨æˆ·æ“ä½œ}
    
    Q -->|ç‚¹å‡» Navigate| R[æ‰“å¼€å¤–éƒ¨åœ°å›¾<br/>Google/Apple Maps]
    Q -->|ç‚¹å‡»ç”µè¯å›¾æ ‡| S[è°ƒç”¨æ‹¨å·ç›˜]
    Q -->|ç‚¹å‡»åº•éƒ¨æŒ‰é’®| T{æ ¹æ®çŠ¶æ€}
    
    T -->|CONFIRMED/EN_ROUTE| U[ğŸ“ åˆ°è¾¾æ‰“å¡]
    T -->|å·²åˆ°è¾¾| V[â–¶ï¸ å¼€å§‹æœåŠ¡]
    T -->|IN_PROGRESS| W[âœ… å®ŒæˆæœåŠ¡]
    
    U --> X[è·³è½¬åˆ° CheckInScreen]
    V --> X
    W --> X
    
    X --> Y[GPS å®šä½]
    Y --> Z[éªŒè¯è·ç¦» < 100m]
    Z -->|æˆåŠŸ| AA[ä¸Šä¼ æ‰“å¡è®°å½•]
    Z -->|å¤±è´¥| AB[æç¤ºè·ç¦»å¤ªè¿œ]
    
    AA --> AC[æ›´æ–°è®¢å•çŠ¶æ€]
    AC --> O
    
    style A fill:#FFE600,stroke:#000,stroke-width:2px
    style H fill:#F9F506,stroke:#000,stroke-width:2px
    style O fill:#135BEC,color:#fff,stroke:#000,stroke-width:2px
    style K fill:#22C55E,stroke:#000,stroke-width:2px
    style AA fill:#22C55E,stroke:#000,stroke-width:2px
```

---

## è®¢å•çŠ¶æ€æµè½¬

```mermaid
stateDiagram-v2
    [*] --> PENDING: å®¢æˆ·ä¸‹å•
    
    PENDING --> CONFIRMED: æŠ€å¸ˆæ¥å•
    PENDING --> CANCELLED: æŠ€å¸ˆæ‹’å•/è¶…æ—¶
    
    CONFIRMED --> EN_ROUTE: æŠ€å¸ˆå‰å¾€
    CONFIRMED --> CANCELLED: å®¢æˆ·å–æ¶ˆ
    
    EN_ROUTE --> æŠ€å¸ˆåˆ°è¾¾: åˆ°è¾¾æ‰“å¡
    
    æŠ€å¸ˆåˆ°è¾¾ --> IN_PROGRESS: å¼€å§‹æœåŠ¡æ‰“å¡
    
    IN_PROGRESS --> COMPLETED: å®ŒæˆæœåŠ¡æ‰“å¡
    
    COMPLETED --> [*]: è®¢å•ç»“æŸ
    CANCELLED --> [*]: è®¢å•ç»“æŸ
    
    note right of PENDING
        å¾…æ¥å•çŠ¶æ€
        æ˜¾ç¤º: æ‹’ç»/æ¥å—æŒ‰é’®
    end note
    
    note right of CONFIRMED
        å·²æ¥å•çŠ¶æ€
        æ˜¾ç¤º: å¼€å§‹å¯¼èˆªæŒ‰é’®
    end note
    
    note right of EN_ROUTE
        å‰å¾€ä¸­çŠ¶æ€
        æ˜¾ç¤º: å¼€å§‹å¯¼èˆªæŒ‰é’®
        åº•éƒ¨: åˆ°è¾¾æ‰“å¡æŒ‰é’®
    end note
    
    note right of IN_PROGRESS
        æœåŠ¡ä¸­çŠ¶æ€
        æ˜¾ç¤º: å¼€å§‹å¯¼èˆªæŒ‰é’®
        åº•éƒ¨: å®ŒæˆæœåŠ¡æŒ‰é’®
    end note
```

---

## é¡µé¢å¯¼èˆªå…³ç³»

```mermaid
graph LR
    A[MainTabs<br/>ä¸»æ ‡ç­¾æ ] --> B[OrdersScreen<br/>è®¢å•åˆ—è¡¨]
    B -->|ç‚¹å‡»å¡ç‰‡| C[OrderDetailsScreen<br/>è®¢å•è¯¦æƒ…]
    C -->|ç‚¹å‡» å¼€å§‹å¯¼èˆª| D[NavigationScreen<br/>åœ°å›¾å¯¼èˆª]
    D -->|ç‚¹å‡» æ‰“å¡æŒ‰é’®| E[CheckInScreen<br/>GPS æ‰“å¡]
    E -->|æ‰“å¡æˆåŠŸ| D
    D -->|è¿”å›| C
    C -->|è¿”å›| B
    
    style A fill:#FFE600,stroke:#000,stroke-width:2px
    style B fill:#F8F8F5,stroke:#000,stroke-width:2px
    style C fill:#F9F506,stroke:#000,stroke-width:2px
    style D fill:#135BEC,color:#fff,stroke:#000,stroke-width:2px
    style E fill:#22C55E,stroke:#000,stroke-width:2px
```

---

## å¯¼èˆªé¡µé¢äº¤äº’æµç¨‹

```mermaid
sequenceDiagram
    participant U as ğŸ‘¤ æŠ€å¸ˆ
    participant N as å¯¼èˆªé¡µé¢
    participant M as å¤–éƒ¨åœ°å›¾
    participant A as API
    participant C as CheckInScreen
    
    U->>N: ç‚¹å‡»"å¼€å§‹å¯¼èˆª"æŒ‰é’®
    activate N
    N->>A: GET /orders/{orderId}
    A-->>N: è¿”å›è®¢å•è¯¦æƒ…
    N->>N: æ˜¾ç¤ºåœ°å›¾ + å®¢æˆ·ä¿¡æ¯
    deactivate N
    
    U->>N: ç‚¹å‡» Navigate æŒ‰é’®
    activate N
    N->>M: Linking.openURL(maps://)
    M-->>U: æ‰“å¼€ Google/Apple Maps
    deactivate N
    
    U->>N: ç‚¹å‡»ç”µè¯å›¾æ ‡
    activate N
    N->>U: Linking.openURL(tel://)
    deactivate N
    
    U->>N: ç‚¹å‡»"åˆ°è¾¾æ‰“å¡"
    activate N
    N->>C: navigate('CheckIn')
    deactivate N
    
    activate C
    C->>C: è·å– GPS å®šä½
    C->>A: POST /orders/{orderId}/checkin
    A-->>C: æ‰“å¡æˆåŠŸ
    C->>N: è¿”å›å¯¼èˆªé¡µé¢
    deactivate C
    
    N->>N: æ›´æ–°çŠ¶æ€ + æŒ‰é’®æ–‡å­—
```

---

## æ•°æ®æµå‘

```mermaid
graph TB
    subgraph Frontend
        A[OrdersScreen] --> B[Redux Store]
        C[OrderDetailsScreen] --> B
        D[NavigationScreen] --> B
        E[CheckInScreen] --> B
    end
    
    subgraph API Layer
        F[orders.ts<br/>API Client]
    end
    
    subgraph Backend
        G[FastAPI<br/>therapist_orders.py]
        H[Database<br/>PostgreSQL]
    end
    
    B <-->|API Call| F
    F <-->|HTTP Request| G
    G <-->|SQL Query| H
    
    style B fill:#FFE600,stroke:#000,stroke-width:2px
    style F fill:#3B82F6,color:#fff,stroke:#000,stroke-width:2px
    style G fill:#22C55E,stroke:#000,stroke-width:2px
    style H fill:#A855F7,color:#fff,stroke:#000,stroke-width:2px
```

---

## å…³é”®ä»£ç æ‰§è¡Œæµç¨‹

```mermaid
flowchart TD
    A[ç”¨æˆ·ç‚¹å‡»è®¢å•å¡ç‰‡] --> B[navigation.navigate<br/>'OrderDetails',<br/>{orderId}]
    B --> C[OrderDetailsScreen<br/>useEffect]
    C --> D[loadOrderDetails]
    D --> E[ordersApi.getOrderDetail<br/>bookingId]
    E --> F[dispatch<br/>setCurrentOrder]
    F --> G{æ£€æŸ¥è®¢å•çŠ¶æ€}
    
    G -->|CONFIRMED/<br/>EN_ROUTE/<br/>IN_PROGRESS| H[æ˜¾ç¤º<br/>å¼€å§‹å¯¼èˆªæŒ‰é’®]
    
    H --> I[ç”¨æˆ·ç‚¹å‡»<br/>å¼€å§‹å¯¼èˆª]
    I --> J[navigation.navigate<br/>'Navigation',<br/>{orderId}]
    
    J --> K[NavigationScreen<br/>useEffect]
    K --> L[loadOrder]
    L --> M[ordersApi.getOrderDetail<br/>orderId]
    M --> N[setOrder]
    
    N --> O[æ¸²æŸ“åœ°å›¾<br/>+ å®¢æˆ·ä¿¡æ¯<br/>+ æ‰“å¡æŒ‰é’®]
    
    O --> P{ç”¨æˆ·æ“ä½œ}
    P -->|Navigate| Q[handleNavigate]
    P -->|Call| R[handleCall]
    P -->|æ‰“å¡| S[navigate<br/>'CheckIn']
    
    Q --> T[Linking.openURL<br/>maps://æˆ–geo://]
    R --> U[Linking.openURL<br/>tel://]
    S --> V[CheckInScreen]
    
    style A fill:#FFE600,stroke:#000,stroke-width:2px
    style H fill:#22C55E,stroke:#000,stroke-width:2px
    style O fill:#135BEC,color:#fff,stroke:#000,stroke-width:2px
    style V fill:#F97316,stroke:#000,stroke-width:2px
```

---

## æ–‡ä»¶ä¾èµ–å…³ç³»

```mermaid
graph TD
    A[OrdersScreen.tsx] --> B[orders.ts<br/>API]
    A --> C[ordersSlice.ts<br/>Redux]
    A --> D[order.ts<br/>Types]
    
    E[OrderDetailsScreen.tsx] --> B
    E --> C
    E --> D
    
    F[NavigationScreen.tsx] --> B
    F --> D
    F --> G[Linking API]
    
    H[CheckInScreen.tsx] --> B
    H --> I[expo-location]
    
    B --> J[client.ts<br/>Axios]
    
    style A fill:#F8F8F5,stroke:#000,stroke-width:2px
    style E fill:#F9F506,stroke:#000,stroke-width:2px
    style F fill:#135BEC,color:#fff,stroke:#000,stroke-width:2px
    style H fill:#22C55E,stroke:#000,stroke-width:2px
    style B fill:#3B82F6,color:#fff,stroke:#000,stroke-width:2px
    style C fill:#FFE600,stroke:#000,stroke-width:2px
```

