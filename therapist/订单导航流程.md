# 📍 技师端订单导航流程

## 完整操作路径

```
首页（订单列表）
    ↓ [点击订单卡片]
订单详情页
    ↓ [点击"开始导航"按钮]
导航页面（地图 + 打卡）
```

---

## 1️⃣ **订单列表页面** (`OrdersScreen.tsx`)

### 位置
- 主 Tab 导航 → "订单" Tab

### 功能
- 显示三个标签页：**待接单** / **进行中** / **已完成**
- 每个订单显示为卡片，包含：
  - 服务类型图标 + 服务名称
  - 客户姓名
  - 订单状态徽章
  - 预约时间
  - 服务地址
  - 服务价格

### 操作
**点击订单卡片** → 跳转到订单详情页

```typescript
onPress={() => navigation.navigate('OrderDetails', { orderId: item.id })}
```

---

## 2️⃣ **订单详情页面** (`OrderDetailsScreen.tsx`)

### 功能
显示订单的完整信息：
- 订单号
- 订单状态
- 预约时间
- 客户信息（头像、姓名、电话）
- 服务地址
- 服务详情（服务名称、时长、价格）
- 价格明细（优惠、积分抵扣等）

### 底部按钮（根据订单状态显示不同按钮）

#### 状态 1: `PENDING`（待接单）
显示两个按钮：
- **拒绝** (灰色)
- **接受订单** (黄色，主色调)

#### 状态 2-4: `CONFIRMED` / `EN_ROUTE` / `IN_PROGRESS`（已接单/前往中/服务中）
显示一个按钮：
- **✅ 开始导航** (蓝色，带导航图标)

```typescript
{(currentOrder.status === BookingStatus.CONFIRMED || 
  currentOrder.status === BookingStatus.EN_ROUTE || 
  currentOrder.status === BookingStatus.IN_PROGRESS) && (
  <View style={styles.footer}>
    <TouchableOpacity 
      style={styles.navigationBtn}
      onPress={() => navigation.navigate('Navigation', { orderId: currentOrder.id })}
    >
      <MaterialIcons name="navigation" size={24} color="white" />
      <Text style={styles.navigationBtnText}>开始导航</Text>
    </TouchableOpacity>
  </View>
)}
```

### 操作
**点击"开始导航"按钮** → 跳转到导航页面

---

## 3️⃣ **导航页面** (`NavigationScreen.tsx`)

### 页面布局
- **上半部分（45%）**：地图区域
  - 显示地图图片（或集成 `react-native-maps`）
  - 地图中心显示蓝色标记点（技师当前位置）
  - 右下角悬浮 **Navigate** 按钮
- **下半部分（55%）**：Bottom Sheet 信息卡片
  - 进度条（ON WAY → ARRIVE → SERVICE → DONE）
  - 预约时间和服务时长
  - 客户地址
  - 客户信息（头像、姓名、电话、聊天按钮）
  - 客户备注（如果有）
  - 底部固定按钮（到达打卡/开始服务/完成服务）

### 关键功能

#### 1. Navigate 按钮（地图右下角）
```typescript
const handleNavigate = () => {
  const lat = order.address_lat || 0;
  const lng = order.address_lng || 0;
  const label = order.address_detail;
  
  // iOS: 打开 Apple Maps
  // Android: 打开 Google Maps
  const url = Platform.select({
    ios: `maps:0,0?q=${encodeURIComponent(label)}@${lat},${lng}`,
    android: `geo:0,0?q=${lat},${lng}(${encodeURIComponent(label)})`
  });
  
  Linking.openURL(url);
};
```

#### 2. 一键拨号
```typescript
const handleCall = () => {
  Linking.openURL(`tel:${order.customer_phone}`);
};
```

#### 3. 底部打卡按钮
根据订单状态显示不同文字：
- **状态 1（已接单/前往中）**: "到达打卡 (Arrive)"
- **状态 2（已到达）**: "开始服务 (Start)"
- **状态 3（服务中）**: "完成服务 (Complete)"

点击后跳转到 `CheckInScreen` 进行定位打卡。

---

## 🔄 订单状态流转

```
PENDING (待接单)
    ↓ [技师接单]
CONFIRMED (已接单)
    ↓ [技师前往]
EN_ROUTE (前往中) 
    ↓ [到达打卡]
(技师到达客户地址)
    ↓ [开始服务打卡]
IN_PROGRESS (服务中)
    ↓ [完成服务打卡]
COMPLETED (已完成)
```

---

## 📦 相关文件

| 文件 | 路径 | 功能 |
|------|------|------|
| 订单列表 | `src/screens/orders/OrdersScreen.tsx` | 显示所有订单（待接单/进行中/已完成） |
| 订单详情 | `src/screens/orders/OrderDetailsScreen.tsx` | 显示订单详细信息，提供接单/导航入口 |
| 导航页面 | `src/screens/orders/NavigationScreen.tsx` | 地图导航 + 打卡入口 |
| 打卡页面 | `src/screens/orders/CheckInScreen.tsx` | GPS 定位打卡（到达/开始/完成） |
| 订单 API | `src/api/orders.ts` | 订单相关接口（列表、详情、接单、打卡） |
| 订单类型 | `src/types/order.ts` | TypeScript 类型定义 |
| 订单 Redux | `src/store/ordersSlice.ts` | 订单状态管理 |

---

## 🎯 用户操作示例

### 场景：技师接单并前往客户地址

1. **步骤 1**：打开 App，进入 "订单" Tab
2. **步骤 2**：看到一个新的 `PENDING` 状态订单
3. **步骤 3**：点击订单卡片，进入订单详情
4. **步骤 4**：查看客户地址、时间等信息
5. **步骤 5**：点击 "接受订单" 按钮
6. **步骤 6**：订单状态变为 `CONFIRMED`，底部出现 **"开始导航"** 按钮
7. **步骤 7**：点击 "开始导航"，进入导航页面
8. **步骤 8**：在地图页面点击右下角 **Navigate** 按钮，打开外部地图应用（Google Maps / Apple Maps）
9. **步骤 9**：跟随导航前往客户地址
10. **步骤 10**：到达后，在导航页面底部点击 **"到达打卡 (Arrive)"**
11. **步骤 11**：GPS 定位打卡成功，订单状态变为 `EN_ROUTE`
12. **步骤 12**：准备开始服务，点击 **"开始服务 (Start)"**
13. **步骤 13**：服务完成后，点击 **"完成服务 (Complete)"**
14. **步骤 14**：订单状态变为 `COMPLETED`，完成整个流程

---

## 🛠️ 技术实现要点

### 1. 外部地图跳转
使用 React Native 的 `Linking` API：
- iOS: `maps:` URL Scheme → Apple Maps
- Android: `geo:` URL Scheme → Google Maps

### 2. 订单状态管理
- 使用 Redux (`ordersSlice`) 管理订单状态
- API 调用后更新本地状态，保持 UI 同步

### 3. GPS 定位打卡
- 使用 `expo-location` 获取当前位置
- 验证距离（需在服务地址 100 米范围内）
- 上传打卡记录到后端

### 4. 实时数据更新
- WebSocket 监听订单状态变更
- 下拉刷新重新加载订单列表

---

## 📝 开发者注意事项

1. **路由参数传递**
   - 使用 `orderId` 在页面间传递订单 ID
   - 确保类型安全（使用 TypeScript）

2. **状态判断**
   - 根据 `BookingStatus` 枚举值显示不同的 UI 和按钮

3. **权限申请**
   - GPS 定位需要申请位置权限
   - 拨打电话需要 `CALL_PHONE` 权限

4. **错误处理**
   - 网络请求失败：显示 Snackbar 提示
   - 定位失败：提示用户检查 GPS 设置
   - 距离超出范围：拒绝打卡并提示

5. **性能优化**
   - 订单列表使用 `FlatList` 实现虚拟滚动
   - 图片使用缓存（`react-native-fast-image`）
   - 避免不必要的重新渲染（`React.memo`, `useCallback`）

---

## ✅ 已完成的功能

- ✅ 订单列表展示（三个 Tab）
- ✅ 订单详情页面
- ✅ 接单/拒单功能
- ✅ **开始导航按钮**（已添加）
- ✅ 导航页面（地图 + 打卡入口）
- ✅ 外部地图跳转（iOS/Android）
- ✅ 一键拨号功能
- ✅ GPS 定位打卡

---

## 🔜 待优化的功能

- 🔲 集成真实地图（`react-native-maps`）
- 🔲 实时路线导航（显示预计到达时间）
- 🔲 聊天功能（需要后端返回 `user_id`）
- 🔲 推送通知（新订单、订单变更）

---

**文档创建时间**: 2025年12月28日  
**最后更新**: 2025年12月28日

