好的，这是提现功能（P1）的完整业务流程图，展示了从前端发起申请到后端处理的全过程，以及涉及的数据模型交互。

```mermaid
sequenceDiagram
    autonumber
    actor Therapist as 技师 (App)
    participant Frontend as 前端 (React Native)
    participant API as 后端 API (FastAPI)
    participant DB as 数据库 (PostgreSQL)

    Note over Therapist, DB: 1. 查询余额流程

    Therapist->>Frontend: 进入"提现页面"
    Frontend->>API: GET /therapist/finance/balance
    API->>DB: 查询 TherapistBalance 表
    alt 账户不存在
        API->>DB: 创建初始账户 (balance=0)
    end
    DB-->>API: 返回余额信息 (balance, frozen_amount)
    API-->>Frontend: { balance: 10000, ... }
    Frontend-->>Therapist: 展示可用余额

    Note over Therapist, DB: 2. 申请提现流程

    Therapist->>Frontend: 输入金额 & 账户信息，点击"确认提现"
    Frontend->>Frontend: 校验金额 (<= 余额) & 表单完整性
    Frontend->>API: POST /therapist/finance/withdrawals
    
    rect rgb(240, 248, 255)
        Note right of API: 事务开始 (Atomic)
        API->>DB: 锁定并查询余额 (Select for Update)
        
        alt 余额不足
            API-->>Frontend: 400 Error: 余额不足
        else 余额充足
            API->>DB: 1. 扣减余额 (balance -= amount)
            API->>DB: 2. 增加冻结 (frozen_amount += amount)
            API->>DB: 3. 创建 Withdrawal 记录 (status=PENDING)
            API->>DB: 4. 创建 Transaction 流水 (type=WITHDRAWAL)
            DB-->>API: 提交事务成功
        end
    end

    API-->>Frontend: 返回提现单详情 (ID, status=PENDING)
    Frontend-->>Therapist: 提示"申请成功，等待审核"
    Frontend->>Frontend: 跳转回/刷新页面

    Note over Therapist, DB: 3. 查看记录流程

    Therapist->>Frontend: 点击"历史记录"
    Frontend->>API: GET /therapist/finance/withdrawals
    API->>DB: 查询 Withdrawal 表 (按时间倒序)
    DB-->>API: 返回记录列表
    API-->>Frontend: [ {id: 1, amount: 100, status: 'pending'...} ]
    Frontend-->>Therapist: 展示提现列表
```

### 关键数据模型交互

```mermaid
erDiagram
    Therapist ||--o| TherapistBalance : "拥有一条余额记录"
    Therapist ||--o{ Withdrawal : "发起多个提现申请"
    Therapist ||--o{ Transaction : "产生多条资金流水"

    TherapistBalance {
        int therapist_id FK
        float balance "可用余额"
        float frozen_amount "提现中冻结金额"
        float total_income "累计总收入"
    }

    Withdrawal {
        int id PK
        float amount "提现金额"
        enum status "PENDING, APPROVED, REJECTED, PAID"
        string account_info "支付宝/微信/银行卡"
    }

    Transaction {
        int id PK
        enum type "INCOME, WITHDRAWAL, REFUND"
        float amount "+/- 金额"
        float balance_after "变动后余额"
        string reference_id "关联 ID"
    }
```

这个流程图涵盖了我们刚刚实现的：
1.  **自动初始化账户**：查询余额时如果不存在则创建。
2.  **原子性事务**：提现时同时扣减余额、增加冻结、生成记录和流水，确保数据一致性。
3.  **状态管理**：提现状态流转（虽然目前只实现了申请 PENDING 之后的流程需要管理员后台操作，目前我们只实现了申请端）。